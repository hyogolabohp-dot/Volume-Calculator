<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>検体必要量計算機</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS (ドラッグ＆ドロップ用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6',
                            600: '#0d9488', 
                            700: '#0f766e',
                        },
                        surface: '#f8fafc',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }
        /* カスタムスクロールバー */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* カード選択時のアニメーション */
        .item-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .item-card:active { transform: scale(0.98); }
        .item-card.selected {
            background-color: #f0fdfa;
            border-color: #0d9488;
            box-shadow: 0 4px 6px -1px rgba(13, 148, 136, 0.1), 0 2px 4px -1px rgba(13, 148, 136, 0.06);
        }
        .item-card.selected .check-icon { opacity: 1; transform: scale(1); }

        /* 管理画面用スタイル */
        .admin-row.sortable-ghost { opacity: 0.4; background: #ccfbf1; }
        .admin-row.sortable-drag { background: #fff; cursor: grabbing; opacity: 1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        /* モーダルアニメーション */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="text-slate-700 min-h-screen pb-44 relative">

    <!-- ==================== 計算機画面 ==================== -->
    <div id="calculatorView" class="block">
        <!-- ヘッダー -->
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 3v12a5 5 0 0 0 5 5h2a5 5 0 0 0 5-5V3" />
                        <line x1="6" y1="6" x2="18" y2="6" />
                    </svg>
                    <h1 class="text-xl font-bold text-slate-800 tracking-wide">検体必要量計算</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="resetAll()" class="text-sm text-slate-500 hover:text-red-500 font-medium transition-colors px-3 py-1 rounded-md hover:bg-slate-100">
                        リセット
                    </button>
                    <!-- 管理画面へ遷移ボタン -->
                    <button onclick="toggleView('admin')" class="p-2 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors" title="管理メニュー">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- 検索バー -->
            <div class="bg-slate-50 border-b border-slate-200">
                <div class="max-w-4xl mx-auto px-4 py-3">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </span>
                        <input type="text" id="searchInput" placeholder="項目名を検索 (例: CRE, TSH, 甲状腺...)" 
                            class="w-full pl-10 pr-4 py-2 bg-white border border-slate-300 rounded-full text-sm focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-all shadow-sm placeholder-slate-400">
                    </div>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="max-w-4xl mx-auto px-4 py-6">
            <!-- 項目リストグリッド -->
            <div id="itemsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>

            <!-- 検索結果なし -->
            <div id="noResults" class="hidden text-center py-12">
                <p class="text-slate-500 font-medium">該当する項目が見つかりません</p>
            </div>
        </main>

        <!-- 固定フッター -->
        <div class="fixed bottom-0 left-0 right-0 bg-white summary-bar z-30 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            <!-- プログレスバー -->
            <div class="h-1.5 w-full bg-slate-100">
                <div id="volumeBar" class="h-full bg-primary-500 transition-all duration-300" style="width: 0%"></div>
            </div>

            <div class="max-w-4xl mx-auto px-4 py-4">
                
                <!-- 選択数（中央上部） -->
                <div class="text-center mb-3">
                    <span class="inline-flex items-center justify-center text-xs text-slate-500 font-medium bg-slate-50 px-3 py-0.5 rounded-full border border-slate-200">
                        選択項目数: <span id="countDisplay" class="font-bold text-slate-700 ml-1">0</span>
                    </span>
                </div>

                <!-- メイン数値エリア（2カラム） -->
                <div class="grid grid-cols-2 gap-3 sm:gap-6">
                    
                    <!-- 左側：必要血清量 (青系) -->
                    <div class="flex flex-col items-center justify-end p-3 rounded-xl bg-blue-50/70 border border-blue-100 shadow-sm relative overflow-hidden">
                        <!-- 装飾用の背景円 -->
                        <div class="absolute -right-2 -top-2 w-10 h-10 bg-blue-100 rounded-full opacity-50"></div>
                        
                        <div class="relative z-10 flex flex-col items-center w-full">
                            <span class="text-xs sm:text-sm font-bold text-blue-700 bg-white/80 border border-blue-200 px-3 py-0.5 rounded-full mb-1 shadow-sm">
                                必要血清量
                            </span>
                            <div class="flex items-baseline gap-1 text-blue-700 leading-none mt-1">
                                <span id="totalDisplay" class="text-5xl sm:text-6xl font-bold font-mono tracking-tight">0</span>
                                <span class="text-lg sm:text-xl font-bold opacity-80">µL</span>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：採血目安量 (赤/ローズ系) -->
                    <div class="flex flex-col items-center justify-end p-3 rounded-xl bg-rose-50/70 border border-rose-100 shadow-sm relative overflow-hidden">
                        <!-- 装飾用の背景円 -->
                        <div class="absolute -right-2 -top-2 w-10 h-10 bg-rose-100 rounded-full opacity-50"></div>

                        <div class="relative z-10 flex flex-col items-center w-full">
                            <span class="text-xs sm:text-sm font-bold text-rose-700 bg-white/80 border border-rose-200 px-3 py-0.5 rounded-full mb-1 shadow-sm">
                                採血目安量
                            </span>
                            <div class="flex items-baseline gap-1 text-rose-600 leading-none mt-1">
                                <span id="bloodDisplay" class="text-5xl sm:text-6xl font-bold font-mono tracking-tight">0</span>
                                <span class="text-lg sm:text-xl font-bold opacity-80">mL</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 管理画面 ==================== -->
    <div id="adminView" class="hidden bg-slate-100 min-h-screen">
        <!-- 管理ヘッダー -->
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <svg class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    管理モード
                </h2>
                <div class="flex gap-2">
                    <button onclick="openCSVImport()" class="text-sm bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-md hover:bg-slate-50 transition-colors">
                        CSV取込
                    </button>
                    <button onclick="toggleView('calculator')" class="text-sm bg-primary-600 text-white px-4 py-1.5 rounded-md hover:bg-primary-700 transition-colors shadow-sm">
                        完了
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-6">
            <!-- デッドボリューム設定 -->
            <div class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-slate-200 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 21h18M5 21v-7l8-4 8 4v7" />
                        <path d="M13 10V3" />
                    </svg>
                    <label for="adminDeadVolume" class="text-sm font-medium text-slate-700">デッドボリューム (µL)</label>
                </div>
                <div class="flex items-center gap-3">
                    <input type="number" id="adminDeadVolume" value="0" min="0" step="1" 
                        class="w-24 text-right px-3 py-1.5 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 font-mono text-lg">
                    <span class="text-xs text-slate-400">※機器の吸い残し分</span>
                </div>
            </div>

            <div class="mb-4 flex justify-between items-center">
                <p class="text-sm text-slate-500">ドラッグ＆ドロップで並び順を変更できます</p>
                <button onclick="openEditModal()" class="text-sm flex items-center gap-1 bg-white border border-primary-500 text-primary-600 px-3 py-1.5 rounded-md hover:bg-primary-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    新規追加
                </button>
            </div>

            <!-- 管理用リスト -->
            <div class="bg-white rounded-lg shadow border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 grid grid-cols-12 gap-4 text-xs font-bold text-slate-500 uppercase tracking-wider">
                    <div class="col-span-1"></div> <!-- Handle -->
                    <div class="col-span-5 md:col-span-4">項目名</div>
                    <div class="col-span-3 md:col-span-2 text-right">量 (µL)</div>
                    <div class="col-span-3 md:col-span-3 hidden md:block">カテゴリ</div>
                    <div class="col-span-3 md:col-span-2 text-right">操作</div>
                </div>
                <ul id="adminList" class="divide-y divide-slate-100">
                    <!-- JSで生成 -->
                </ul>
            </div>
            
            <div class="mt-8 text-center">
                <button onclick="resetToDefault()" class="text-xs text-red-400 hover:text-red-600 underline">
                    初期データに戻す
                </button>
            </div>
        </main>
    </div>

    <!-- ==================== 編集モーダル ==================== -->
    <div id="editModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeEditModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modalTitle">項目の追加/編集</h3>
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">項目名</label>
                            <input type="text" id="editName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">必要量 (µL)</label>
                                <input type="number" id="editVol" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">カテゴリ</label>
                                <input type="text" id="editCategory" list="categoryList" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                                <datalist id="categoryList">
                                    <option value="生化学"></option>
                                    <option value="免疫"></option>
                                    <option value="電解質"></option>
                                    <option value="血液"></option>
                                </datalist>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="saveItem()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        保存
                    </button>
                    <button type="button" onclick="closeEditModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== CSVインポート用input (hidden) ==================== -->
    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleCSVSelect(this)">

    <script>
        // デフォルトデータ
        const defaultItems = [
            { id: 1, name: 'TP', vol: 3, category: '生化学' },
            { id: 2, name: 'ALB', vol: 2, category: '生化学' },
            { id: 3, name: 'UN', vol: 2, category: '生化学' },
            { id: 4, name: 'T-Bil', vol: 4, category: '生化学' },
            { id: 5, name: 'D-Bil', vol: 4, category: '生化学' },
            { id: 6, name: 'AST', vol: 5, category: '生化学' },
            { id: 7, name: 'ALT', vol: 5, category: '生化学' },
            { id: 8, name: 'LD', vol: 3, category: '生化学' },
            { id: 9, name: 'LAP', vol: 3, category: '生化学' },
            { id: 10, name: 'CK', vol: 3, category: '生化学' },
            { id: 11, name: 'γ-GT', vol: 4, category: '生化学' },
            { id: 12, name: 'ChE', vol: 4, category: '生化学' },
            { id: 13, name: 'ALP', vol: 3, category: '生化学' },
            { id: 14, name: 'AMY', vol: 3, category: '生化学' },
            { id: 15, name: 'GLU', vol: 5, category: '生化学' },
            { id: 16, name: 'Na.K.Cl', vol: 15, category: '電解質' },
            { id: 17, name: 'Ca', vol: 4, category: '電解質' },
            { id: 18, name: 'P', vol: 2, category: '電解質' },
            { id: 19, name: 'Mg', vol: 2, category: '電解質' },
            { id: 20, name: 'T-CHO', vol: 2, category: '脂質' },
            { id: 21, name: 'CRE', vol: 3, category: '生化学' },
            { id: 22, name: 'UA', vol: 3, category: '生化学' },
            { id: 23, name: 'CRP', vol: 3, category: '免疫' },
            { id: 24, name: 'TG', vol: 2, category: '脂質' },
            { id: 25, name: 'IgG', vol: 2, category: '免疫' },
            { id: 26, name: 'IgA', vol: 2, category: '免疫' },
            { id: 27, name: 'IgM', vol: 2, category: '免疫' },
            { id: 28, name: 'C3', vol: 3, category: '免疫' },
            { id: 29, name: 'C4', vol: 3, category: '免疫' },
            { id: 30, name: 'β2M', vol: 2, category: '免疫' },
            { id: 31, name: 'シスタチンC', vol: 2, category: '生化学' },
            { id: 32, name: 'LIPASE', vol: 2, category: '生化学' },
            { id: 33, name: 'HDL-C', vol: 2, category: '脂質' },
            { id: 34, name: 'LDL-C', vol: 2, category: '脂質' },
            { id: 35, name: 'Fe', vol: 8, category: '生化学' },
            { id: 36, name: 'UIBC', vol: 8, category: '生化学' },
            { id: 37, name: 'フェリチン', vol: 20, category: '免疫' },
            { id: 38, name: 'バンコマイシン', vol: 2, category: '薬物' },
            { id: 39, name: 'フェノバルビタール', vol: 2, category: '薬物' },
            { id: 40, name: 'カルバマゼピン', vol: 2, category: '薬物' },
            { id: 41, name: 'バルプロ酸', vol: 2, category: '薬物' },
            { id: 42, name: 'メトトレキサート', vol: 10, category: '薬物' },
            { id: 43, name: 'HBsAg', vol: 75, category: '感染症' },
            { id: 44, name: 'HBsAb', vol: 75, category: '感染症' },
            { id: 45, name: 'HBcAb', vol: 25, category: '感染症' },
            { id: 46, name: 'HCVAb', vol: 20, category: '感染症' },
            { id: 47, name: 'HIVAgAb', vol: 100, category: '感染症' },
            { id: 48, name: 'FT3', vol: 22, category: 'ホルモン' },
            { id: 49, name: 'FT4', vol: 34, category: 'ホルモン' },
            { id: 50, name: 'TSH', vol: 113, category: 'ホルモン' },
            { id: 51, name: 'AFP', vol: 25, category: '腫瘍マーカー' },
            { id: 52, name: 'トロポニンI', vol: 160, category: '心マーカー' },
            { id: 53, name: 'ゲンタマイシン', vol: 2, category: '薬物' },
            { id: 54, name: 'プロカルシトニン', vol: 20, category: '免疫' },
            { id: 55, name: 'BNP', vol: 20, category: '心マーカー' },
            { id: 56, name: 'KL-6', vol: 20, category: '免疫' },
            { id: 57, name: 'PSA', vol: 10, category: '腫瘍マーカー' },
            { id: 58, name: 'CEA', vol: 10, category: '腫瘍マーカー' },
            { id: 59, name: '血清浸透圧', vol: 50, category: '生化学' }
        ];

        // 状態変数
        let testItems = [];
        let selectedIds = new Set();
        let deadVolume = 0;
        let sortableInstance = null;

        // DOM要素
        const grid = document.getElementById('itemsGrid');
        const adminList = document.getElementById('adminList');
        const searchInput = document.getElementById('searchInput');
        const totalDisplay = document.getElementById('totalDisplay');
        const countDisplay = document.getElementById('countDisplay');
        const bloodDisplay = document.getElementById('bloodDisplay');
        const noResults = document.getElementById('noResults');
        const volumeBar = document.getElementById('volumeBar');
        const editModal = document.getElementById('editModal');
        // デッドボリューム設定用
        const adminDeadVolume = document.getElementById('adminDeadVolume');

        // ================= 初期化・データ管理 =================

        function init() {
            loadData();
            renderItems(testItems);
            
            // イベントリスナー
            searchInput.addEventListener('input', (e) => filterItems(e.target.value));
            
            // 管理画面デッドボリューム入力のリスナー
            if (adminDeadVolume) {
                adminDeadVolume.value = deadVolume;
                adminDeadVolume.addEventListener('input', (e) => {
                    deadVolume = parseInt(e.target.value) || 0;
                    saveDeadVolume();
                    calculateTotal();
                });
            }

            // SortableJS初期化 (管理画面用)
            sortableInstance = new Sortable(adminList, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    // 並び順更新
                    const newIndex = evt.newIndex;
                    const oldIndex = evt.oldIndex;
                    const item = testItems.splice(oldIndex, 1)[0];
                    testItems.splice(newIndex, 0, item);
                    saveData();
                    // 計算機画面も再描画
                    renderItems(testItems);
                },
            });
        }

        function loadData() {
            // アイテムのロード
            const savedItems = localStorage.getItem('specimen_items');
            if (savedItems) {
                testItems = JSON.parse(savedItems);
            } else {
                testItems = JSON.parse(JSON.stringify(defaultItems)); // Deep copy
            }

            // デッドボリュームのロード
            const savedDeadVolume = localStorage.getItem('specimen_dead_volume');
            if (savedDeadVolume) {
                deadVolume = parseInt(savedDeadVolume);
            } else {
                deadVolume = 0;
            }
        }

        function saveData() {
            localStorage.setItem('specimen_items', JSON.stringify(testItems));
            calculateTotal(); // 削除された項目が選択されていた場合の再計算など
        }

        function saveDeadVolume() {
            localStorage.setItem('specimen_dead_volume', deadVolume);
        }

        function resetToDefault() {
            if (confirm('全てのデータを初期状態に戻しますか？追加・編集した内容は失われます。')) {
                localStorage.removeItem('specimen_items');
                // デッドボリュームもリセットする場合
                // localStorage.removeItem('specimen_dead_volume'); 
                loadData();
                renderItems(testItems);
                renderAdminList();
                if(adminDeadVolume) adminDeadVolume.value = deadVolume;
                calculateTotal();
                alert('初期データに戻しました');
            }
        }

        // ================= 計算機画面ロジック =================

        function renderItems(items) {
            grid.innerHTML = '';
            
            if (items.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }

            items.forEach(item => {
                const card = document.createElement('div');
                const isSelected = selectedIds.has(item.id);
                
                card.className = `item-card relative bg-white rounded-lg p-4 border border-transparent shadow-sm cursor-pointer hover:shadow-md select-none ${isSelected ? 'selected' : 'border-slate-100'}`;
                card.onclick = () => toggleSelection(item.id, card);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-lg text-slate-700 break-words leading-tight">${item.name}</span>
                        <div class="check-icon w-5 h-5 bg-primary-500 rounded-full flex items-center justify-center transition-all duration-200 opacity-0 transform scale-75">
                            <svg class="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 truncate max-w-[60%]">${item.category || '未分類'}</span>
                        <span class="font-mono text-xl font-bold ${isSelected ? 'text-primary-600' : 'text-slate-400'}">${item.vol}<span class="text-xs font-normal ml-0.5 text-slate-400">µL</span></span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleSelection(id, cardElement) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
                cardElement.classList.remove('selected');
                cardElement.classList.add('border-slate-100');
                const volText = cardElement.querySelector('.font-mono');
                volText.classList.remove('text-primary-600');
                volText.classList.add('text-slate-400');
            } else {
                selectedIds.add(id);
                cardElement.classList.add('selected');
                cardElement.classList.remove('border-slate-100');
                const volText = cardElement.querySelector('.font-mono');
                volText.classList.remove('text-slate-400');
                volText.classList.add('text-primary-600');
            }
            calculateTotal();
            if (navigator.vibrate) navigator.vibrate(5);
        }

        function filterItems(query) {
            const lowerQuery = query.toLowerCase();
            const filtered = testItems.filter(item => 
                (item.name && item.name.toLowerCase().includes(lowerQuery)) || 
                (item.category && item.category.toLowerCase().includes(lowerQuery))
            );
            renderItems(filtered);
            // 選択状態の維持ロジックは簡略化のため省略（IDベースなので計算は維持される）
        }

        function calculateTotal() {
            let sum = 0;
            // 存在しないIDが残っていないかフィルタリングしつつ計算
            const validSelectedIds = new Set();
            
            selectedIds.forEach(id => {
                const item = testItems.find(i => i.id === id);
                if (item) {
                    sum += item.vol;
                    validSelectedIds.add(id);
                }
            });
            
            // 削除された項目のIDを除去
            selectedIds = validSelectedIds;

            // 必要総量
            const total = selectedIds.size > 0 ? sum + deadVolume : 0;
            
            // 採血目安 (必要総量 * 2, 1の位を切り上げ = 10の位で丸める)
            // 例: 121 -> 242 -> 250(µL) -> 0.25(mL)
            const bloodEstimateMicro = total > 0 ? Math.ceil((total * 2) / 10) * 10 : 0;
            const bloodEstimateMilli = bloodEstimateMicro / 1000;

            animateValue(totalDisplay, parseInt(totalDisplay.innerText), total, 300);
            animateValue(bloodDisplay, parseFloat(bloodDisplay.innerText), bloodEstimateMilli, 300, true); // 小数アニメーション
            countDisplay.innerText = selectedIds.size;
            
            const percentage = Math.min((total / 1000) * 100, 100);
            volumeBar.style.width = `${percentage}%`;
            
            // 色の制御（バーのみ琥珀色に変更するロジックに変更）
            if (total > 500) {
                // バーの色を変更
                volumeBar.classList.remove('bg-primary-500');
                volumeBar.classList.add('bg-amber-500');
            } else {
                // バーの色を戻す
                volumeBar.classList.add('bg-primary-500');
                volumeBar.classList.remove('bg-amber-500');
            }
        }

        function animateValue(obj, start, end, duration, isFloat = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let current = progress * (end - start) + start;
                
                if (isFloat) {
                    // 小数の場合は小数点以下を調整して表示
                    // 不要な0を消すため parseFloat を使用
                    obj.innerHTML = parseFloat(current.toFixed(2));
                } else {
                    obj.innerHTML = Math.floor(current);
                }
                
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        window.resetAll = function() {
            selectedIds.clear();
            searchInput.value = '';
            renderItems(testItems);
            calculateTotal();
        }

        // ================= 管理画面ロジック =================

        window.toggleView = function(viewName) {
            const calcView = document.getElementById('calculatorView');
            const adminView = document.getElementById('adminView');

            if (viewName === 'admin') {
                calcView.classList.add('hidden');
                adminView.classList.remove('hidden');
                renderAdminList();
                // 管理画面を開いたときにデッドボリュームの値をセット
                if(adminDeadVolume) adminDeadVolume.value = deadVolume;
            } else {
                adminView.classList.add('hidden');
                calcView.classList.remove('hidden');
                // 管理画面での変更を反映して再描画
                renderItems(testItems);
            }
        }

        function renderAdminList() {
            adminList.innerHTML = '';
            testItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'admin-row bg-white flex items-center px-4 py-3 hover:bg-slate-50 transition-colors group';
                li.innerHTML = `
                    <div class="grid grid-cols-12 gap-4 w-full items-center">
                        <div class="col-span-1 drag-handle text-slate-300 hover:text-slate-500 cursor-grab flex justify-center">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" /></svg>
                        </div>
                        <div class="col-span-5 md:col-span-4 font-bold text-slate-700 truncate">${item.name}</div>
                        <div class="col-span-3 md:col-span-2 text-right font-mono text-slate-600">${item.vol} µL</div>
                        <div class="col-span-3 md:col-span-3 text-sm text-slate-500 hidden md:block truncate">${item.category || '-'}</div>
                        <div class="col-span-3 md:col-span-2 flex justify-end gap-2">
                            <button onclick="openEditModal(${item.id})" class="text-primary-600 hover:text-primary-800 p-1">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button onclick="deleteItem(${index})" class="text-red-400 hover:text-red-600 p-1">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                `;
                adminList.appendChild(li);
            });
        }

        // 編集・追加モーダル関連
        window.openEditModal = function(id = null) {
            editModal.classList.remove('hidden');
            const title = document.getElementById('modalTitle');
            const idInput = document.getElementById('editId');
            const nameInput = document.getElementById('editName');
            const volInput = document.getElementById('editVol');
            const catInput = document.getElementById('editCategory');

            if (id) {
                const item = testItems.find(i => i.id === id);
                title.innerText = '項目の編集';
                idInput.value = item.id;
                nameInput.value = item.name;
                volInput.value = item.vol;
                catInput.value = item.category;
            } else {
                title.innerText = '項目の追加';
                idInput.value = '';
                nameInput.value = '';
                volInput.value = '';
                catInput.value = '';
            }
        }

        window.closeEditModal = function() {
            editModal.classList.add('hidden');
        }

        window.saveItem = function() {
            const idInput = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            const vol = parseInt(document.getElementById('editVol').value);
            const category = document.getElementById('editCategory').value;

            if (!name || isNaN(vol)) {
                alert('項目名と必要量は必須です');
                return;
            }

            if (idInput) {
                // 編集
                const index = testItems.findIndex(i => i.id == idInput);
                if (index !== -1) {
                    testItems[index] = { ...testItems[index], name, vol, category };
                }
            } else {
                // 追加 (新しいIDを生成)
                const newId = testItems.length > 0 ? Math.max(...testItems.map(i => i.id)) + 1 : 1;
                testItems.push({ id: newId, name, vol, category });
            }

            saveData();
            renderAdminList();
            closeEditModal();
        }

        window.deleteItem = function(index) {
            if (confirm('この項目を削除しますか？')) {
                testItems.splice(index, 1);
                saveData();
                renderAdminList();
            }
        }

        // ================= CSVインポート =================

        window.openCSVImport = function() {
            document.getElementById('csvInput').click();
        }

        window.handleCSVSelect = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
                input.value = ''; // Reset for same file selection
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            try {
                const lines = text.split(/\r\n|\n/);
                const newItems = [];
                let startId = 1;

                // ヘッダー行をスキップするか判定 (簡単な判定: 1行目に数値が含まれていなければヘッダーとみなす)
                let startIndex = 0;
                if (lines.length > 0) {
                    const firstRowCols = lines[0].split(',');
                    // 2カラム目の値が数値でなければヘッダーとみなす
                    if (firstRowCols.length >= 2 && isNaN(parseInt(firstRowCols[1]))) {
                        startIndex = 1;
                    }
                }

                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const cols = line.split(',');
                    if (cols.length >= 2) {
                        const name = cols[0].trim();
                        const vol = parseInt(cols[1].trim());
                        // 3列目があればカテゴリとする、なければ自動判別は難しいので空にする
                        const category = cols[2] ? cols[2].trim() : '未分類';

                        if (name && !isNaN(vol)) {
                            newItems.push({
                                id: startId++,
                                name: name,
                                vol: vol,
                                category: category
                            });
                        }
                    }
                }

                if (newItems.length > 0) {
                    if (confirm(`${newItems.length}件のデータを読み込みました。現在のリストを上書きしますか？`)) {
                        testItems = newItems;
                        saveData();
                        renderAdminList();
                        alert('インポートが完了しました');
                    }
                } else {
                    alert('有効なデータが見つかりませんでした。CSVのフォーマットを確認してください（例: 項目名,必要量,カテゴリ）');
                }
            } catch (e) {
                console.error(e);
                alert('CSVの読み込みに失敗しました');
            }
        }

        // 開始
        init();

    </script>
</body>
</html>
